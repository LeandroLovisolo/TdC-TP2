
\documentclass[a4paper, 10pt, twoside]{article}

\usepackage[top=1in, bottom=1in, left=1in, right=1in]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[spanish, es-ucroman, es-noquoting]{babel}
\usepackage{setspace}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{verbatim}
\usepackage{graphicx}
\usepackage{float}
\usepackage{enumitem} % Provee macro \setlist
\usepackage{tabularx}
\usepackage{multirow}
\usepackage{hyperref}
\usepackage{bytefield}
\usepackage[toc, page]{appendix}


%%%%%%%%%% Configuración de Fancyhdr - Inicio %%%%%%%%%%
\pagestyle{fancy}
\thispagestyle{fancy}
\lhead{Trabajo Práctico 2 · Teoría de las Comunicaciones}
\rhead{Delgado · Lovisolo · Petaccio}
\renewcommand{\footrulewidth}{0.4pt}
\cfoot{\thepage /\pageref{LastPage}}

\fancypagestyle{caratula} {
   \fancyhf{}
   \cfoot{\thepage /\pageref{LastPage}}
   \renewcommand{\headrulewidth}{0pt}
   \renewcommand{\footrulewidth}{0pt}
}
%%%%%%%%%% Configuración de Fancyhdr - Fin %%%%%%%%%%


%%%%%%%%%% Miscelánea - Inicio %%%%%%%%%%
% Evita que el documento se estire verticalmente para ocupar el espacio vacío
% en cada página.
\raggedbottom

% Separación entre párrafos.
\setlength{\parskip}{0.5em}

% Separación entre elementos de listas.
\setlist{itemsep=0.5em}

% Asigna la traducción de la palabra 'Appendices'.
\renewcommand{\appendixtocname}{Apéndices}
\renewcommand{\appendixpagename}{Apéndices}
%%%%%%%%%% Miscelánea - Fin %%%%%%%%%%


%%%%%%%%%% Insertar estadísticas - Inicio %%%%%%%%%%
\newcommand{\estadisticas}[3]{
  \begin{figure}[H]
    \small
    \verbatiminput{#1}
    \normalsize
    \caption{#2}
    \label{#3}
  \end{figure}
}
%%%%%%%%%% Insertar estadísticas - Fin %%%%%%%%%%


%%%%%%%%%% Insertar gráfico - Inicio %%%%%%%%%%
\newcommand{\grafico}[3]{
  \begin{figure}[H]
    \includegraphics[type=pdf,ext=.pdf,read=.pdf]{#1}
    \caption{#2}
    \label{#3}
  \end{figure}
}
%%%%%%%%%% Insertar gráfico - Fin %%%%%%%%%%


%%%%%%%%%% Nombres de las universidades - Inicio %%%%%%%%%%
\newcommand{\oxford}{University of Oxford}
\newcommand{\sydney}{The University of Sydney}
\newcommand{\must}{Malaysia University of Science and Technology}
%%%%%%%%%% Nombres de las universidades - Fin %%%%%%%%%%


\begin{document}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Carátula                                                                  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\thispagestyle{caratula}

\begin{center}

\includegraphics[height=2cm]{DC.png} 
\hfill
\includegraphics[height=2cm]{UBA.jpg} 

\vspace{2cm}

Departamento de Computación,\\
Facultad de Ciencias Exactas y Naturales,\\
Universidad de Buenos Aires

\vspace{4cm}

\begin{Huge}
Trabajo Práctico 2
\end{Huge}

\vspace{0.5cm}

\begin{Large}
Teoría de las Comunicaciones
\end{Large}

\vspace{1cm}

Primer Cuatrimestre de 2014

\vspace{4cm}

\begin{tabular}{|c|c|c|}
\hline
Apellido y Nombre & LU & E-mail\\
\hline
Delgado, Alejandro N.  & 601/11 & nahueldelgado@gmail.com\\
Lovisolo, Leandro      & 645/11 & leandro@leandro.me\\
Petaccio, Lautaro José & 443/11 & lausuper@gmail.com\\
\hline
\end{tabular}

\end{center}

\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Índice                                                                    %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\tableofcontents

\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Introducción                                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Introducción}

En este trabajo estudiamos un método para detectar enlaces submarinos en la traza de paquetes entre dos hosts conectados a internet.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Desarrollo                                                                %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Desarrollo}

Se implementó una herramienta en lenguaje Python para medir los \emph{round-trip times} (RTT) promedio hacia el host destino y cada hop intermedio durante una cantidad de tiempo determinada por el usuario. La herramienta hace fuerte uso del protocolo ICMP \cite{rfc-792} tanto para descubrir la cantidad de hops y los gateways en cada hop hacia el host destino, como para medir los RTT hacia el host destino y cada hop intermedio (de manera similar a las herramientas \texttt{traceroute} \cite{wiki-traceroute} y \texttt{ping} \cite{wiki-ping}, respectivamente.)

La herramienta hace uso la biblioteca Scapy \cite{scapy} para la creación y comunicación de paquetes ICMP.

Una medición consiste en enviar un paquete ICMP de tipo Echo Request al host destino, asignándole al paquete algún \emph{time-to-live} (TTL) entre 1 y 30 inclusive, y tomar el tiempo que transcurre desde que se envía el paquete hasta que se recibe una respuesta. Las respuestas usualmente son de alguno de los siguientes tipos:

\begin{itemize}
  \item Un paquete ICMP de tipo Echo Reply en caso que el paquete emitido alcanzara el host destino, ó
  \item Un paquete ICMP de tipo Time Exceeded en caso que el paquete agotara su TTL antes de llegar al host destino.
\end{itemize}

Es posible recibir respuestas de otros tipos, como por ejemplo paquetes ICMP de tipo Destination Unreachable en el caso que no se haya podido despachar el paquete a su destino por algún motivo, pero la herramienta ignora cualquier respuesta que no sea de los dos tipos anteriores.

Para medir el RTT hacia el host destino, basta con enviarle un paquete a dicho host con un TTL lo suficientemente grande para asegurar que su TTL no se agote durante el envío del paquete, esperar hasta recibir un paquete ICMP de tipo Echo Reply proveniente del host destino.

Para medir el RTT hacia el $i$-ésimo hop en la ruta al host destino, se le asigna al paquete un TTL de valor $i$. Esto produce que el paquete agote su TTL al llegar al $i$-éstimo host, a lo cual éste responde con un paquete ICMP de tipo Time Exceeded.

Tanto cuando se mide el RTT hacia el host destino o hacia un hop intermedio puede ocurrir que no se reciba ninguna respuesta, por ejemplo cuando el host o algún gateway está detrás de un firewall que bloquea el protocolo ICMP. Para evitar esperar indefinidmente una respuesta, la herramienta espera como máximo un segundo la llegada de una respuesta, y si al cabo de ese tiempo no se recibe una, se descarta esa medición.

Las mediciones se hacen por baches: en un determinado momento se envían 30 paquetes al host destino, uno por cada TTL en el rango mencionado y todos con TTL distinto, y se espera o bien hasta recibir las respuestas de todos los paquetes enviados, o bien hasta que transcurra un segundo y se den por perdidas las mediciones para las que no se recibieron respuestas. A continuación se registra el RTT hacia cada hop computando la diferencia entre el tiempo de recepción de una respuesta y el tiempo de envío del paquete de tipo Echo Request que la originó. Luego de esto se procede al siguiente bache de mediciones, o se finaliza en caso de haber excedido el límite de tiempo de medición determinado por el usuario.

Para poder distinguir qué paquete produjo cada respuesta recibida, la herramienta le asigna un identificador único a cada paquete ICMP de tipo Echo Request emitido usando el campo \emph{Identifier} (ver figura \ref{fig:icmp-echo-request}.)

\begin{figure}[H]
  \vspace{2em}
  \begin{center}
    \begin{bytefield}[bitwidth=1.1em]{32}
      \bitheader{0-31} \\
      \bitbox{8}{Type = 8} & \bitbox{8}{Code = 0} & \bitbox{16}{Header Checksum} \\
      \bitbox{16}{Identifier} & \bitbox{16}{Sequence Number} \\
      \bitbox{32}{\emph{Datos}}
    \end{bytefield}
  \end{center}
  \caption{Paquete ICMP de tipo Echo Request}
  \label{fig:icmp-echo-request}
\end{figure}

En el caso que un paquete ICMP de tipo Echo Request haya llegado al host destino, éste contesta enviando un paquete ICMP de tipo Echo Reply (figura \ref{fig:icmp-echo-reply}.) Este paquete también tiene un campo \emph{Identifier}, que conserva el valor del mismo campo en el paquete ICMP de tipo Echo Request que lo originó.

\begin{figure}[H]
  \vspace{2em}
  \begin{center}
    \begin{bytefield}[bitwidth=1.1em]{32}
      \bitheader{0-31} \\
      \bitbox{8}{Type = 0} & \bitbox{8}{Code = 0} & \bitbox{16}{Header Checksum} \\
      \bitbox{16}{Identifier} & \bitbox{16}{Sequence Number} \\
      \bitbox{32}{\emph{Datos}}
    \end{bytefield}
  \end{center}
  \caption{Paquete ICMP de tipo Echo Reply}
  \label{fig:icmp-echo-reply}
\end{figure}

Cuando un paquete (no necesariamente ICMP) agota su TTL antes de llegar al host destino, el último gateway al que llegó dicho paquete envía al host origen un paquete ICMP de tipo Time Exceeded (figura \ref{fig:icmp-time-exceeded}.) Éste paquete incluye el header IP y los primeros 8 bytes de datos del datagrama que agotó su TTL.

\begin{figure}[H]
  \vspace{2em}
  \begin{center}
    \begin{bytefield}[bitwidth=1.1em]{32}
      \bitheader{0-31} \\
      \bitbox{8}{Type = 11} & \bitbox{8}{Code} & \bitbox{16}{Header Checksum} \\
      \bitbox{32}{\emph{No utilizado}} \\
      \wordbox{2}{\emph{Header IP y los primeros 8 bytes de datos del datagrama original} \\ $\vdots$}
    \end{bytefield}
  \end{center}
  \caption{Paquete ICMP de tipo Time Exceeded}
  \label{fig:icmp-time-exceeded}
\end{figure}

En particular, cuando el paquete que agotó su TTL es un paquete ICMP de tipo Echo Request, su header ICMP completo se incluye como parte de los 8 bytes de datos del datagrama original, del cual se puede extraer el valor del campo \emph{Identifier} (ver figura \ref{fig:icmp-time-exceeded-echo-request}.) 

\begin{figure}[H]
  \vspace{2em}
  \begin{center}
    \begin{bytefield}[bitwidth=1.1em]{32}
      \bitheader{0-31} \\
      \bitbox{8}{Type = 11} & \bitbox{8}{Code} & \bitbox{16}{Header Checksum} \\
      \bitbox{32}{\emph{No utilizado}} \\
      \bitbox{32}{\emph{Header IP del paquete original}} \\
      \begin{rightwordgroup}{Header ICMP \\ del paquete \\ original}
        \bitbox{8}{Type = 8} & \bitbox{8}{Code = 0} & \bitbox{16}{Header Checksum} \\
        \bitbox{16}{Identifier} & \bitbox{16}{Sequence Number}
      \end{rightwordgroup}
    \end{bytefield}
  \end{center}
  \caption{Paquete ICMP de tipo Time Exceeded como respuesta a otro paquete ICMP de tipo Echo Request}
  \label{fig:icmp-time-exceeded-echo-request}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Resultados                                                                %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Resultados}


\subsection{\oxford}

\estadisticas{statistics-www.ox.ac.uk.txt}
             {Traza hacia \oxford}
             {fig:trace-oxford}

\grafico{map-www.ox.ac.uk}
        {Ruta hacia \oxford}
        {fig:map-oxford}

\grafico{rtt-www.ox.ac.uk}
        {RTT de los gateways de la ruta hacia \oxford}
        {fig:rtt-oxford}

\grafico{zrtt-www.ox.ac.uk}
        {ZRTT de los gateways de la ruta hacia \oxford}
        {fig:zrtt-oxford}


\subsection{\sydney}

\estadisticas{statistics-www.sydney.edu.au.txt}
             {Traza hacia \sydney}
             {fig:trace-sydney}

\grafico{map-www.sydney.edu.au}
        {Ruta hacia \sydney}
        {fig:map-sydney}

\grafico{rtt-www.sydney.edu.au}
        {RTT de los gateways de la ruta hacia \sydney}
        {fig:rtt-sydney}

\grafico{zrtt-www.sydney.edu.au}
        {ZRTT de los gateways de la ruta hacia \sydney}
        {fig:zrtt-sydney}


\subsection{\must}

\estadisticas{statistics-www.must.edu.my.txt}
             {Traza hacia \must}
             {fig:trace-must}

\grafico{map-www.must.edu.my}
        {Ruta hacia \must}
        {fig:map-must}

\grafico{rtt-www.must.edu.my}
        {RTT de los gateways de la ruta hacia \must}
        {fig:rtt-must}

\grafico{zrtt-www.must.edu.my}
        {ZRTT de los gateways de la ruta hacia \must}
        {fig:zrtt-must}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Discusión                      			                                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Discusión}

Teniendo como referencia los resultados obtenidos, notamos que ocurrieron algunos fenónemos en común que creemos vale la pena mencionar.

\subsection{Primer nodo externo}
Podemos notar, en los resultados de todas las universidades analizadas, que el segundo nodo, el primer nodo que no es nuestro gateway, posee un RTT promedio alto en comparación a los nodos más próximos a éste. Podemos deducir que esto se debe a que este router tiene una prioridad baja para las respuestas a paquetes ICMP, haciendo que las respuestas tarden más de lo esperado.

\subsection{Posible error de localización}
Otro punto a tener en cuenta, también visible en los resultados de los traceroutes a todas las universidades, es que la biblioteca elegida para la geolocalización sitúa muy probablemente la localización de los IP según la procedencia de la compañía que realice el enlace entre países. Pueden notarse en los resultados hops con bajo ZRTT relativo entre distintos países y luego el próximo nodo dentro del segundo país tiene un ZRTT relativo muy alto, indicando probablemente que se trata de un enlace de gran distancia.

\subsection{Promedios de RTT}
Un dato estadístico anómalo general es el de obtener, para un determinado nodo, un RTT absoluto menor al RTT absoluto del nodo anterior, lo que significaría que llegar a este nodo toma menos tiempo que llegar al anterior. Esta anomalía se debe a que los valores del RTT absolutos se calculan mediante el promedio de los RTT obtenidos para cada nodo, pudiendo el paquete ICMP haber tomado caminos diferentes y habiendo conseguido llegar de manera apenas más rápida en promedio.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Conclusión                                                                %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Conclusión}

\label{foo}

Pendiente.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Referencias                                                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{thebibliography}{9}

\bibitem{scapy}
	\emph{Scapy Project}.
	\url{http://www.secdev.org/projects/scapy}, 
	Mayo de 2014.

\bibitem{rfc-792}
  \emph{RFC 792: Internet Control Message Protocol}.
  \url{http://tools.ietf.org/html/rfc792}.

\bibitem{wiki-traceroute}
  \emph{Traceroute}.
  \url{http://en.wikipedia.org/wiki/Traceroute},
  Mayo de 2014.

\bibitem{wiki-ping}
  \emph{Ping (network utility) (Artículo en Wikipedia)}.
  \url{http://en.wikipedia.org/wiki/Ping_(networking_utility)},
  Mayo de 2014.

\bibitem{wiki-icmp}
  \emph{Internet Control Message Protocol (Artículo en Wikipedia)}.
  \url{http://en.wikipedia.org/wiki/Internet_Control_Message_Protocol},
  Mayo de 2014.
	
\end{thebibliography}


\end{document}